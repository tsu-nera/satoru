# V2 vs V3 解析結果の比較

## 実装の違い

### V2（以前）
- `get_hrv_data()`: SelfLoopsの`HR (bpm)`列を使用
- 心拍数: デバイスが計算した値をそのまま使用

### V3（新実装）
- `get_hrv_data()`: R-R間隔から計算 + 外れ値除外（デフォルト）
- 心拍数: HRV Task Force基準で外れ値を除外して計算

## 結果の比較

### SelfLoops心拍数の統計

| 指標 | V2 (HR列) | V3 (R-R計算) | 差分 |
|------|----------:|-------------:|-----:|
| 平均心拍数 | 74.76 bpm | 74.30 bpm | -0.46 |
| データポイント | 788 | 788 | 0 |

### Muse vs SelfLoops一致度

| 指標 | V2 | V3 | 差分 |
|------|----:|----:|-----:|
| 相関係数 | -0.0145 | 0.0855 | +0.1000 |
| 平均絶対誤差 | 4.21 bpm | 5.00 bpm | +0.79 |
| RMSE | 5.35 bpm | 6.27 bpm | +0.92 |

## 考察

### なぜ誤差が増加したのか？

**仮説**: SelfLoopsの`HR (bpm)`列は、何らかの平滑化処理が施されている可能性

1. **V2（HR列使用）**:
   - SelfLoopsアプリが内部で平滑化
   - Museとの見かけ上の一致度が向上

2. **V3（R-R間隔から計算）**:
   - 生のR-R間隔から計算（外れ値除外のみ）
   - より生データに近い、瞬時的な心拍数変動を反映
   - Museとの微小な時間差や測定方法の違いが顕在化

### 相関係数の変化

- V2: -0.0145（ほぼ無相関、負の相関）
- V3: +0.0855（弱い正の相関）

V3の方が正の相関を示しており、より自然な結果と言える。

## 結論

### どちらの方法が正しいか？

**V3（R-R間隔から計算）が学術的に正しい**:

1. **標準化**: HRV研究の標準手法
2. **再現性**: 処理が明確で再現可能
3. **汎用性**: Elite HRV、Polar等にも対応可能
4. **透明性**: SelfLoopsのHR列の処理内容は不明

### 誤差の増加について

誤差の増加は**問題ではなく、より正確な評価**:

- MuseのPPG心拍数とSelfLoopsのECG心拍数は測定原理が異なる
- 瞬時的な心拍数変動の捉え方が異なるのは自然
- V2の低い誤差は、SelfLoopsの平滑化による見かけの改善

### 推奨

**V3の実装を採用すべき**:
- 学術的に正しい手法
- 将来の拡張性（他のHRVアプリ対応）
- 処理の透明性

MuseとSelfLoopsの心拍数に若干の差異があるのは、測定方法の違いによる自然な結果。
