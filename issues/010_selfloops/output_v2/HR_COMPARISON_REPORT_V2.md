# Muse vs SelfLoops 心拍数比較分析レポート (v2)

## 概要

Muse EEGのPPG（光学式）心拍数とSelfLoops HRVのECG心拍数を比較し、
測定精度と信頼性を評価しました。

**Note**: このレポートは新しいlib.loaders.selfloopsとlib.sensors.ecgを使用したv2版です。

### 測定方式の違い

**Muse（PPG - Photoplethysmography）**
- 測定方式: 光学式（緑色LED）
- 測定部位: 耳後部（TP9/TP10）
- 原理: 血液量変化による光の吸収変化を検出
- 特徴: 非侵襲的、装着が容易

**SelfLoops（ECG - Electrocardiogram）**
- 測定方式: 電気信号（R-R間隔から計算）
- 測定部位: 胸部ストラップ（推定）
- 原理: 心臓の電気活動を直接測定
- 特徴: 医療グレードの精度、ゴールドスタンダード

---

## 比較データサマリー

### 基本統計

| 指標 | Muse (PPG) | SelfLoops (ECG) | 単位 |
|:-----|----------:|----------------:|:-----|
| 平均心拍数 | 75.38 | 74.76 | bpm |
| 標準偏差 | 4.39 | 2.95 | bpm |
| 最小値 | 66.73 | 68.00 | bpm |
| 最大値 | 88.03 | 82.00 | bpm |
| データポイント数 | 788 | 788 | - |

---

## 一致度分析

### 相関分析

| 指標 | 値 |
|:-----|---:|
| **Pearson相関係数** | -0.0145 |
| **p値** | 0.685338 |
| **解釈** | 相関が弱い |

### Bland-Altman分析

| 指標 | 値 | 説明 |
|:-----|---:|:-----|
| **平均差** | 0.62 bpm | Muse - SelfLoopsの平均値 |
| **標準偏差** | 5.32 bpm | 差の標準偏差 |
| **LoA上限** | 11.05 bpm | 平均 + 1.96SD |
| **LoA下限** | -9.81 bpm | 平均 - 1.96SD |

> **Limits of Agreement (LoA)**: 95%のデータ点がこの範囲内に入る

### 誤差指標

| 指標 | 値 | 説明 |
|:-----|---:|:-----|
| **平均絶対誤差** | 4.21 bpm | |Muse - SelfLoops|の平均 |
| **中央絶対誤差** | 3.37 bpm | |Muse - SelfLoops|の中央値 |
| **平均相対誤差** | 5.67 % | 誤差の割合 |
| **RMSE** | 5.35 bpm | 二乗平均平方根誤差 |

---

## 可視化

![心拍数比較](hr_comparison_v2.png)

---

## 1分ごとの詳細比較

以下は1分ごとの平均心拍数と誤差の詳細です。

| 経過時間 | Muse平均 | Muse SD | SelfLoops平均 | SelfLoops SD | 差分 | 絶対誤差 | サンプル数 |
|:---------|--------:|---------:|-------------:|------------:|-----:|---------:|----------:|
|  0分 |  79.99 |  3.80 |  76.52 |  2.79 |  3.48 |  3.48 |  60 |
|  1分 |  75.47 |  4.19 |  76.50 |  3.11 | -1.03 |  1.03 |  60 |
|  2分 |  77.73 |  3.88 |  74.12 |  3.42 |  3.62 |  3.62 |  60 |
|  3分 |  73.94 |  4.64 |  73.63 |  2.18 |  0.31 |  0.31 |  60 |
|  4分 |  74.80 |  4.08 |  75.72 |  2.91 | -0.92 |  0.92 |  60 |
|  5分 |  75.96 |  4.14 |  74.38 |  2.55 |  1.58 |  1.58 |  60 |
|  6分 |  74.19 |  4.34 |  73.48 |  2.78 |  0.71 |  0.71 |  60 |
|  7分 |  74.62 |  4.43 |  74.28 |  2.53 |  0.34 |  0.34 |  60 |
|  8分 |  73.99 |  3.52 |  73.02 |  2.63 |  0.97 |  0.97 |  60 |
|  9分 |  73.50 |  4.40 |  73.18 |  2.64 |  0.32 |  0.32 |  60 |
| 10分 |  74.30 |  3.96 |  75.57 |  2.89 | -1.27 |  1.27 |  60 |
| 11分 |  75.45 |  4.39 |  73.97 |  1.90 |  1.49 |  1.49 |  60 |
| 12分 |  76.29 |  3.00 |  77.13 |  1.42 | -0.84 |  0.84 |  60 |
| 13分 |  73.45 |  1.46 |  78.00 |  0.00 | -4.55 |  4.55 |   8 |

> **注**:
> - 差分 = Muse - SelfLoops（正の値はMuseが高い）
> - 絶対誤差 = |差分|
> - SD = 標準偏差（その分の変動幅）

---

## 評価と結論

### 1. 測定精度

**相関係数: {stats_dict['correlation']:.3f}**
- {'非常に高い相関を示しており、MuseとSelfLoopsは類似した心拍数トレンドを捉えている' if stats_dict['correlation'] > 0.9 else '高い相関を示しており、両者は同様の傾向を示す' if stats_dict['correlation'] > 0.8 else '中程度の相関。一部の測定で乖離がある可能性'}

**平均絶対誤差: {stats_dict['mean_abs_diff']:.2f} bpm**
- {'非常に良好な一致' if stats_dict['mean_abs_diff'] < 2 else '良好な一致' if stats_dict['mean_abs_diff'] < 5 else '中程度の一致' if stats_dict['mean_abs_diff'] < 10 else '一致度が低い'}
- {'臨床的に許容可能な範囲内' if stats_dict['mean_abs_diff'] < 5 else '一部のアプリケーションでは注意が必要'}

### 2. バイアス（系統誤差）

**平均差: {stats_dict['mean_diff']:.2f} bpm**
- {'Museは若干高めに測定' if stats_dict['mean_diff'] > 1 else 'Museは若干低めに測定' if stats_dict['mean_diff'] < -1 else '系統誤差はほぼゼロ'}
- {'一貫したバイアスがあるため、補正可能' if abs(stats_dict['mean_diff']) > 2 else 'バイアスは小さく、臨床的に無視できるレベル'}

### 3. どちらがより信頼できるか？

**SelfLoops (ECG)が医療的ゴールドスタンダード**

理由：
1. **測定原理**: ECGは心臓の電気活動を直接測定するため、最も正確
2. **医療グレード**: HRV分析のゴールドスタンダード
3. **R-R間隔**: 心拍ごとの正確な間隔を測定可能

**Muse (PPG)の利点と限界**

利点：
- 非侵襲的で装着が容易
- EEGと同時測定が可能
- {'平均心拍数の推定には十分な精度' if stats_dict['mean_abs_diff'] < 5 else '概算としては使用可能'}

限界：
- 動作アーティファクトに敏感
- {'瞬間的な心拍数変動（HRV）の測定には不向き' if stats_dict['correlation'] < 0.95 else 'HRV分析にも使用可能だが、ECGより精度は劣る'}
- 測定部位（耳後部）の血流により影響を受ける

### 4. 推奨される使用シーン

**SelfLoops (ECG)を推奨:**
- HRV分析（SDNN、RMSSD、LF/HFなど）
- 正確な心拍数変動の測定が必要な場合
- 医療・研究用途

**Muse (PPG)で十分:**
- 平均心拍数のモニタリング
- トレンドの把握
- EEG分析と組み合わせた瞑想分析

---

## 改善の提案

### 1. Museの精度向上

- 測定前にセンサー部位の清掃
- ヘッドバンドの適切な装着（締め付けすぎない）
- 動作を最小限に抑える

### 2. データ統合の最適化

- {'バイアス補正: Muse HR = 測定値 - {stats_dict["mean_diff"]:.2f} bpm' if abs(stats_dict['mean_diff']) > 2 else 'バイアス補正は不要'}
- 移動平均フィルタの適用でノイズ除去

### 3. 用途に応じた選択

- **瞑想の質的評価**: Muse PPGで十分（トレンドが重要）
- **HRV詳細分析**: SelfLoops ECGを使用（精度が重要）

---

## まとめ

- **相関**: {stats_dict['correlation']:.3f}（{'優秀' if stats_dict['correlation'] > 0.9 else '良好' if stats_dict['correlation'] > 0.8 else '中程度'}）
- **平均誤差**: {stats_dict['mean_abs_diff']:.2f} bpm（{'許容範囲' if stats_dict['mean_abs_diff'] < 5 else '要注意'}）
- **推奨**: **精密測定にはSelfLoops ECG、EEG統合分析にはMuse PPG**

---

## 技術的改善点（v1からv2）

### コード改善
- `lib.loaders.selfloops`の使用により、データ読み込みが標準化
- `get_hrv_data()`により、心拍数データが直接取得可能
- タイムスタンプのパース処理が共通化され、保守性向上

### 今後の拡張性
- `lib.sensors.ecg.analysis`を使用することで、NeuroKit2の高度なHRV解析が可能
- 時間領域、周波数領域、非線形領域の詳細なHRV指標を追加可能

---

生成日時: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
