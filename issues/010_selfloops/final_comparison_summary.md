# V2 vs V3 最終比較まとめ

## 実装の違い

| 項目 | V2（旧） | V3（新・推奨） |
|------|---------|--------------|
| データソース | SelfLoopsのHR列 | R-R間隔から計算 |
| 処理 | デバイスの計算値をそのまま使用 | HRV Task Force基準で外れ値除外 |
| 汎用性 | SelfLoops専用 | ✅ Elite HRV、Polar等にも対応可能 |
| 透明性 | ❌ 処理内容不明 | ✅ 処理内容が明確 |

---

## 重要な発見：SelfLoopsのHR列は平滑化されている

### SelfLoopsデータの統計比較

| 指標 | V2 (HR列) | V3 (R-R計算) | Muse (参考) | 観察 |
|------|----------:|-------------:|------------:|------|
| 平均 | 74.76 bpm | 73.67 bpm | 75.38 bpm | V3が1.09 bpm低い |
| **標準偏差** | **2.95 bpm** | **4.53 bpm** | **4.39 bpm** | **V2は異常に低い** |
| 最小値 | 68.00 bpm | 63.22 bpm | 66.73 bpm | V2は範囲が狭い |
| 最大値 | 82.00 bpm | 88.37 bpm | 88.03 bpm | V2は範囲が狭い |
| 範囲 | 14.00 bpm | 25.15 bpm | 21.30 bpm | - |

### 解釈

1. **V2のHR列は平滑化されている**:
   - 標準偏差が2.95 bpm（異常に低い）
   - Museの標準偏差（4.39 bpm）と比較して33%低い
   - 値の範囲が狭い（14 bpm vs V3の25 bpm）

2. **V3は自然な心拍変動を捉えている**:
   - 標準偏差が4.53 bpm（Museの4.39と近い）
   - より広い心拍数範囲を捉えている
   - 瞬時的な変動を反映

---

## Muse vs SelfLoops 一致度分析

### 相関分析

| 指標 | V2 | V3 | 解釈 |
|------|----:|----:|------|
| Pearson相関 | -0.0145 | **0.0855** | V3で正の相関 |
| p値 | 0.685 | **0.016** | **V3で有意（p<0.05）** |
| 統計的有意性 | ❌ 非有意 | ✅ **有意** | V3で初めて有意な相関 |

**重要**: V3で初めて統計的に有意な正の相関が検出されました。

### Bland-Altman分析

| 指標 | V2 | V3 | 解釈 |
|------|----:|----:|------|
| 平均差 | 0.62 bpm | 1.71 bpm | V3でやや増加 |
| 差の標準偏差 | 5.32 bpm | 6.03 bpm | V3でやや増加 |
| 平均絶対誤差 | 4.21 bpm | 5.00 bpm | V3でやや増加 |
| RMSE | 5.35 bpm | 6.27 bpm | V3でやや増加 |

---

## なぜV3の方が誤差が大きいのに優れているのか？

### V2の低い誤差の原因

1. **SelfLoopsの平滑化**:
   - HR列がアプリ内で平滑化処理されている
   - 瞬時的な変動が削られている
   - 見かけ上、Museとの差が小さく見える

2. **測定タイミングのミスマッチ**:
   - 平滑化により、測定タイミングの違いが隠蔽される
   - 真の測定精度を反映していない

### V3の高い誤差の意味

1. **真の測定差を反映**:
   - PPG（Muse）とECG（SelfLoops）の測定原理の違い
   - 測定タイミングの微小な差
   - センサー位置の違い（耳 vs 胸）

2. **より自然な心拍変動**:
   - 瞬時的な心拍数変動を捉えている
   - Museと同程度の変動を示す（標準偏差が近い）
   - 統計的に有意な相関を示す

---

## 視覚的な理解

```
V2（HR列使用）:
SelfLoops心拍数: ━━━━━━━━━ （平滑化されている）
Muse心拍数:      ～～～～～～～ （自然な変動）
                 ↑ 見かけ上の一致度は高いが、不自然

V3（R-R間隔から計算）:
SelfLoops心拍数: ～～～～～～～ （自然な変動）
Muse心拍数:      ～～～～～～～ （自然な変動）
                 ↑ 変動パターンが似ている、統計的に有意な相関
```

---

## 結論

### ✅ V3（R-R間隔から計算）を採用すべき理由

1. **学術的正当性**:
   - HRV研究の標準手法
   - 処理内容が明確で再現可能
   - 統計的に有意な相関を検出

2. **データの質**:
   - 自然な心拍変動を捉えている
   - Museと同程度の変動（標準偏差4.53 vs 4.39）
   - 外れ値除外のみで過度な平滑化なし

3. **将来性**:
   - Elite HRV、Polar等にも同じコードで対応可能
   - 処理の透明性により、研究での使用に適している

### ❌ V2の問題点

1. **データの人為的な改変**:
   - SelfLoopsの平滑化により自然な変動が失われている
   - 標準偏差が異常に低い（2.95 bpm）

2. **見かけの一致度**:
   - 低い誤差は平滑化によるアーティファクト
   - 統計的に有意な相関が見られない（p=0.685）

3. **再現性の欠如**:
   - SelfLoopsの処理内容が不明
   - 他のHRVアプリに適用できない

---

## 推奨事項

### 瞑想研究での使用

**V3の実装を使用する**:
```python
from lib.loaders.selfloops import load_selfloops_csv, get_hrv_data

# デフォルト設定（推奨）
df = load_selfloops_csv('data.csv')
hrv_data = get_hrv_data(df)  # clean_artifacts=True
```

### MuseとSelfLoopsの併用

- 両者の心拍数に差があるのは自然（測定方法の違い）
- V3では統計的に有意な相関が確認されている（p=0.016）
- 平均差は1.71 bpm（臨床的に許容範囲）

### HRV解析

R-R間隔から計算したデータを使用することで:
- RMSSD、SDNN等の時間領域指標が正確
- LF、HF等の周波数領域指標が信頼できる
- 学術論文での使用に適している

---

**最終推奨**: V3の実装（R-R間隔から計算 + 外れ値除外）を標準として採用する
