# 呼吸数とHF Peak周波数の検証 (2026-01-16)

## 問題の発見

HRVレポートに追加した**HF Peak (0.156 Hz = 9.4 bpm)**が、実際の呼吸周期（15-30秒/回）と一致しないことが判明。

## 検証結果

### 1. 実際の呼吸周期との比較

| 項目 | 値 | 周期 | 評価 |
|------|-----|------|------|
| **ユーザー証言** | - | 15-30秒/回 | 実際の呼吸 |
| **Mean BR** | 3.8 bpm | 15.8秒/回 | ✓ 一致 |
| **Spectral BR** | 9.4 bpm | 6.4秒/回 | ✗ 不一致 |
| **HF Peak** | 0.156 Hz = 9.4 bpm | 6.4秒/回 | ✗ 不一致 |

### 2. 呼吸数から周波数への変換

```
実際の呼吸: 15-30秒/回
→ 周波数: 1/30 - 1/15 = 0.033-0.067 Hz
→ 呼吸数: 2-4 bpm
→ 該当帯域: VLF-LF帯域 (0.0-0.15 Hz)
```

### 3. HF Peak (0.156 Hz) の正体

**これは呼吸ではなく、別の生理現象:**
- Mayer波（血圧の自発的振動、通常0.1 Hz付近）
- 圧受容体反射 (Baroreflex)
- 自律神経調節の周期性
- 心拍と呼吸の非線形相互作用

**証拠:**
1. Spectral BR (9.4 bpm) と HF Peak (0.156 Hz = 9.4 bpm) が完全に一致
2. 両方とも 0.15-0.4 Hz 帯域で検出されている
3. 実際の呼吸周期（15-30秒/回）とは明らかに異なる

### 4. アルゴリズムの問題

#### 現在の実装（respiration.py:206-207）

```python
# 呼吸帯域（0.15-0.4 Hz = 9-24 bpm）でピーク検出
br_mask = (freqs >= 0.15) & (freqs <= 0.4)
```

**問題点:**
- **固定範囲 0.15-0.4 Hz (9-24 bpm)** は通常の安静時呼吸を想定
- 深い瞑想呼吸（2-4 bpm = 0.033-0.067 Hz）は完全に範囲外
- この範囲で検出される信号は呼吸ではない

#### 同じ問題が以前から存在

**issue 011の分析結果（2026-01-12）:**
```
平均呼吸数（ピーク検出）: 4.2 ± 1.2 bpm  ← 実際の呼吸
スペクトル法による呼吸数:   9.4 bpm        ← 謎の信号
```

→ 当時から同じ現象が起きていたが、見過ごされていた

### 5. 2つの検出手法の比較

| 手法 | 検出範囲 | 今回の結果 | 実際の意味 |
|------|---------|-----------|-----------|
| **ピーク検出法** | データ駆動 | 4.2-7.6 bpm | 実際の呼吸に近い |
| **Spectral BR** | 固定 0.15-0.4 Hz | 9.4 bpm | 呼吸ではない |

**注意:** ピーク検出法も瞬時値では高めに出る傾向があるが、3分ウィンドウの平均を取ると実際の呼吸に近くなる。

### 6. パワースペクトル全体の分析

**全周波数帯域の主要ピーク（2026-01-16データ）:**

```
1. 0.0469 Hz (2.8 bpm)  - LF帯域  - 最大パワー (100%)
2. 0.0625 Hz (3.8 bpm)  - LF帯域  - 58.8%  ← Mean BR
3. 0.1562 Hz (9.4 bpm)  - HF帯域  - 24.0%  ← Spectral BR/HF Peak
```

→ **実際の呼吸はLF帯域 (0.04-0.15 Hz) に存在**

### 7. 0.25 Hz ピークについて

グラフで目立つ0.25 Hz (15 bpm)ピークの正体:
- **基本呼吸周波数の4次高調波**: 3.8 bpm × 4 = 15.2 bpm ≈ 0.253 Hz
- パワーは HF Peak の約35%
- 深い呼吸の非線形性による高調波成分

## 検証スクリプト

### 作成したスクリプト

1. **verify_breathing_rate.py**
   - 複数の周波数範囲でSpectral BRを計算
   - ピーク検出法との比較
   - 可視化とレポート生成

2. **以前のスクリプト（参考）**
   - scripts/debug_peak_freq.py: ピーク周波数の詳細分析
   - scripts/verify_breathing_period.py: 周波数→周期の変換検証
   - scripts/analyze_025hz_peak.py: 0.25 Hz ピークの分析

### 実行方法

```bash
# 検証スクリプト実行
source venv/bin/activate
python issues/011_br_analysis/verify_breathing_rate.py

# データファイル指定
python issues/011_br_analysis/verify_breathing_rate.py \
    /path/to/selfloops.csv
```

### 出力

- **BREATHING_VALIDATION_REPORT.md**: 検証結果レポート
- **breathing_rate_validation.png**: 可視化図

## 推奨される修正

### 1. Spectral BR の周波数範囲を適応的に変更

```python
# 深い瞑想データには低周波範囲を使用
if peak_detected_br < 6:  # ピーク検出法が6 bpm未満なら
    br_mask = (freqs >= 0.033) & (freqs <= 0.15)  # 2-9 bpm
else:  # 通常呼吸
    br_mask = (freqs >= 0.15) & (freqs <= 0.4)    # 9-24 bpm
```

### 2. レポートに注釈を追加

**呼吸指標セクション:**
```markdown
> **⚠️ Spectral BRについて**:
> - 深い瞑想状態（呼吸周期15-30秒/回）では、Spectral BR (9.4 bpm) は
>   実際の呼吸ではなく、Mayer波や圧受容体反射などの別の生理現象を
>   捉えている可能性があります
> - 実際の呼吸数は Mean BR (3.8 bpm) を参照してください
```

**HRV周波数領域セクション:**
```markdown
> **⚠️ HF Peakについて**:
> - 深い瞑想状態では、HF Peak (0.15-0.4 Hz) は呼吸性洞性不整脈(RSA)
>   ではなく、別の自律神経調節メカニズムを示している可能性があります
> - 実際の呼吸周波数は LF帯域 (0.04-0.15 Hz) に現れます
```

### 3. HF Peak の表記を変更

現在:
- "HF Peak" → 呼吸を示唆してしまう

提案:
- "HF Band Peak Frequency" → より中立的
- または "HF Peak (non-respiratory)" → 明示的に非呼吸と注記

## 残された疑問

1. **0.156 Hz の生理学的意味は何か？**
   - Mayer波の可能性が高いが、確定には文献調査が必要
   - 瞑想状態特有の現象か、一般的な現象か

2. **なぜピーク検出法でも高めの値が出るのか？**
   - EDR信号の生成過程に問題がある可能性
   - NeuroKit2のパラメータ調整が必要か

3. **他のデータでも同じ現象が起きるか？**
   - 複数のセッションで検証が必要
   - 通常の呼吸速度（12-20 bpm）のデータとの比較

## 参考資料

### 関連ファイル

- `lib/sensors/ecg/respiration.py`: 呼吸分析実装
- `lib/sensors/ecg/hrv.py`: HRV解析実装（HF Peak計算）
- `issues/011_br_analysis/analyze_breathing.py`: 以前の呼吸分析
- `issues/011_br_analysis/BREATHING_REPORT.md`: 以前の分析結果

### データファイル

- `data/selfloops/selfloops_2026-01-16--07-18-39.csv`: 今回検証データ
- `data/selfloops/selfloops_2026-01-12--06-21-05.csv`: 以前の分析データ

### 生成された検証結果

- `issues/011_br_analysis/BREATHING_VALIDATION_REPORT.md`
- `issues/011_br_analysis/breathing_rate_validation.png`
- `tmp/hrv/025hz_analysis.png`

## 次のステップ

### 明日の作業（2026-01-17）

1. **複数データでの検証**
   - 他の瞑想セッションデータで同じ現象が起きるか確認
   - 通常呼吸速度のデータとの比較

2. **実装の修正検討**
   - Spectral BRの周波数範囲を適応的に変更
   - ピーク検出法のパラメータ調整

3. **レポート表記の改善**
   - HF Peakの注釈追加
   - Spectral BRの注釈追加

4. **文献調査**
   - Mayer波と瞑想状態の関連
   - 深い呼吸時のHRV周波数成分
   - RSAの周波数範囲に関する研究

---

**調査者**: Claude
**日付**: 2026-01-16
**ステータス**: 要継続調査
